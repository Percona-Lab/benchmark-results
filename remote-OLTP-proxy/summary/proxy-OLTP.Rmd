---
title: "local PK"
author: "None"
date: "March 17, 2016"
--output: html_document
output:
  md_document:
    variant: markdown_github

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggthemes)
library(reshape2)
library(knitr)
library("RMySQL")
library(stringr)

con <- dbConnect(MySQL(), user="sbtest", dbname="benchmarks", host="10.20.2.4")

tm<-theme(legend.position="bottom",
          text=element_text(family="Georgia"),
          strip.background = element_rect(colour="red", fill="#CCCCFF"))

guides(colour = guide_legend(override.aes = list(size=4)))

```
# MySQL 5.7 - proxy overhead

## Setup

* Client (sysbench) and server are on different servers, connected via 10Gb network. 
* CPU: 56 logical CPU threads servers Intel(R) Xeon(R) CPU E5-2683 v3 @ 2.00GHz
* sysbench 10 tables x 10mln rows, pareto distribution
* OS: Ubuntu 15.10 (Wily Werewolf)
* Kernel 4.2.0-30-generic

* MaxScale 1.4.1 - self compiled

```{r test, eval=FALSE, fig.height=8, fig.width=10, warning=FALSE, include=FALSE}
ss=subset(aggdata)

m <- ggplot(ss, aes(x=as.factor(Group.2),y=as.numeric(V2),color=as.factor(Group.1),group=Group.1))
m+geom_line()+geom_point(size=1)+labs(x="Threads",y="Throughput,tps",title="sysbench read-only")+scale_color_tableau(name="Version")+scale_y_continuous(breaks=seq(0, 480000, 20000),labels = scales::comma)+theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm
```
```{r test2, eval=FALSE, fig.height=8, fig.width=10, warning=FALSE, include=FALSE}
ss=subset(aggdata)

m <- ggplot(ss, aes(x=as.factor(Group.2),y=as.numeric(V3),color=as.factor(Group.1),group=Group.1))
m+geom_line()+geom_point(size=1)+labs(x="Threads",y="Throughput,tps",title="sysbench read-only")+scale_color_tableau(name="Version")+scale_y_log10(breaks=c(.001,.01,0.05,.1,.5,1,10,100,250,500,1000),limits = c(.01,1000))
#+theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm
```
## Results

```{r i1, echo=FALSE, warning=FALSE,fig.width=10, fig.height=8}
p2 = dbGetQuery( con,'select sr.runid runidfull,sr.threads, tps, rt
                 from sbtest_results sr,(select runid,threads from sbtest_results group by runid,threads having count(*) > 10) t 
                 where sec>100 and sec<600 and (sr.runid like "OLTP-RO-MEM%") and
                 (sr.runid like "%maxscale%" or sr.runid like "%proxysql%" or sr.runid like "%mysql57.long2%")
                 and sr.runid=t.runid and sr.threads=t.threads
                 ' )
p2$runid <- str_extract(p2$runidfull, "([^#]*)$")
aggdata <-aggregate(p2, by=list(p2$runid,p2$threads),FUN=mean, na.rm=TRUE)
ss=subset(aggdata, str_detect(Group.1, "maxscale.8thr")| str_detect(Group.1, "proxysql.16thr.fast")|str_detect(Group.1, "proxysql.old")|str_detect(Group.1, "mysql57.long2"))
m <- ggplot(ss, aes(x=as.numeric(Group.2),y=as.numeric(tps),color=as.factor(Group.1),group=Group.1))
m+geom_line()+geom_point(size=1)+
  labs(x="Threads",y="Throughput,tps",title="sysbench read-only")+
  scale_color_tableau(name="Version")+
  scale_y_log10(breaks=seq(0, 20000, 1000),labels = scales::comma)+
  scale_x_log10(breaks=c(1,2,3,4,5,6,8,10,13,16,20,25,31,38,46,56,68,82,100,120,145,175,210,250,300,360,430,520,630,750,870,1000))+
  theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm

```

### MaxScale variance on high threads
```{r i2, echo=FALSE, warning=FALSE,fig.width=10, fig.height=8}
library(stringr)
ss=subset(p2, str_detect(runid, "maxscale.8thr")| str_detect(runid, "proxysql.16thr.fast")|str_detect(runid, "proxysql.old"))
m <- ggplot(ss, aes(x=as.factor(threads),y=as.numeric(tps),color=runid))
m+geom_boxplot()+labs(x="Threads",y="Throughput,tps",title="sysbench read-only")+scale_color_tableau(name="Version")+scale_y_continuous(labels = scales::comma)+theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm

```

### Relative performance 

base value: MySQL 5.7

```{r schema-relative, echo=FALSE, fig.height=4, fig.width=10, message=FALSE, warning=FALSE}
Res<-data.frame(aggdata$Group.1, aggdata$Group.2, aggdata$tps)

wide_format <- dcast(subset(Res), aggdata.Group.2 ~ aggdata.Group.1)


ss=subset(aggdata,(Group.2<=1000))
#ss=subset(aggdata)
wide_format$`ProxySQL, 16 threads fast-forward` = wide_format$`mysql57.proxysql.16thr.fast-forwars`/wide_format$`mysql57.long`
wide_format$`ProxySQL, 16 threads` = wide_format$`mysql57.proxysql.oldintel`/wide_format$`mysql57.long`
wide_format$`MaxScale, 8 threads` = wide_format$`mysql57.maxscale.8thr`/wide_format$`mysql57.long`

dat_m <- melt(subset(wide_format), id.vars = "aggdata.Group.2", measure.vars=c("ProxySQL, 16 threads fast-forward","ProxySQL, 16 threads","MaxScale, 8 threads"))

m <- ggplot(dat_m, 
            aes(x=as.factor(aggdata.Group.2),y=as.numeric(value),group=variable))
m+geom_bar(stat = "identity",position = "dodge",aes(fill = as.factor(variable)))+geom_hline(yintercept=1)+geom_text(aes(label=format(value, digits=2, nsmall=2), 
                hjust=1), 
            position = position_dodge(width=0.9),size=3,angle = 90)+labs(x="Threads",y="relative performance",title="sysbench OLTP RO, ProxySQL overhead 5.7")+scale_fill_tableau(name="Version")+scale_y_continuous(breaks=seq(0, 1.5, 0.1),labels = scales::comma)+theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm
```


## Previous Results with proxysql

* Vanilla MySQL 5.7
* ProxySQL `mysql-threads=16`
* MaxScale 1.3.0
  * MaxScale `threads=4`
  * MaxScale `threads=8`
  * MaxScale `threads=16`


ProxySQL is running on the same host with sysbench, connected via unix-socket

```{r versions, echo=FALSE, warning=FALSE,fig.width=10, fig.height=8}
data = read.table("../summary.csv",sep=",",header=F)
data1=subset(data,V1>100)
attach(data1)
aggdata <-aggregate(data1, by=list(V4,V5),FUN=mean, na.rm=TRUE)
ss=subset(aggdata,(Group.2<=1000) )
#ss=subset(aggdata)

m <- ggplot(ss, 
            aes(x=as.factor(Group.2),y=as.numeric(V2),color=as.factor(Group.1),group=Group.1))
m+geom_line()+geom_point(size=1)+labs(x="Threads",y="Throughput, tps",title="sysbench OLTP RO")+scale_color_tableau(name="Version")+scale_y_continuous(breaks=seq(0, 20000, 1000),labels = scales::comma)+theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm
```

### Relative performance 

base value: MySQL 5.7

```{r perf-schema-relative, eval=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, include=FALSE}
Res<-data.frame(aggdata$Group.1, aggdata$Group.2, aggdata$V2)

wide_format <- dcast(subset(Res), aggdata.Group.2 ~ aggdata.Group.1)


ss=subset(aggdata,(Group.2<=1000))
#ss=subset(aggdata)
wide_format$`ProxySQL, 16 threads` = wide_format$`res.mysql57.proxysql.16threads`/wide_format$`res.mysql57.long`

dat_m <- melt(subset(wide_format), id.vars = "aggdata.Group.2", measure.vars=c("ProxySQL, 16 threads"))

m <- ggplot(dat_m, 
            aes(x=as.factor(aggdata.Group.2),y=as.numeric(value),group=variable))
m+geom_bar(stat = "identity",position = "dodge",aes(fill = as.factor(variable)))+geom_hline(yintercept=1)+geom_text(aes(label=format(value, digits=2, nsmall=2), 
                hjust=1), 
            position = position_dodge(width=0.9),size=3,angle = 90)+labs(x="Threads",y="relative performance",title="sysbench OLTP RO, ProxySQL overhead 5.7")+scale_fill_tableau(name="Version")+scale_y_continuous(breaks=seq(0, 1.5, 0.1),labels = scales::comma)+theme(axis.text.x  = element_text(angle=45, vjust=0.5))+tm
```
